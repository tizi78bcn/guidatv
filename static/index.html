<!DOCTYPE html>
<html lang="it">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Partite trasmesse</title>
    <style>
        body { font-family: Arial, sans-serif; }
        h1 { margin-bottom: 10px; }
        #filters label { margin-right: 8px; }
        table { border-collapse: collapse; margin-top: 16px; width: 100%; }
        th, td { border: 1px solid #444; padding: 6px 9px; text-align: center; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Partite trasmesse</h1>
    <div id="filters">
        <label>Data:
            <select id="filter-date"><option value="Tutte">Tutte</option></select>
        </label>
        <label>Squadra:
            <select id="filter-team"><option value="Tutte">Tutte</option></select>
        </label>
        <label>Competizione:
            <select id="filter-comp"><option value="Tutte">Tutte</option></select>
        </label>
        <input type="text" id="filter-search" placeholder="Cerca squadra...">
    </div>
    <table id="matches-table">
        <thead>
            <tr>
                <th>Data</th>
                <th>Casa</th>
                <th>Trasferta</th>
                <th>Competizione</th>
                <th>Canale</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

<script>
let matches = [];

// Format date for dropdown: "Dom, 19/10"
function formatDateOptionShort(dateString) {
    const dateObj = new Date(dateString);
    const days = ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"];
    const dayOfWeek = days[dateObj.getDay()];
    const day = String(dateObj.getDate()).padStart(2, '0');
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    return `${dayOfWeek}, ${day}/${month}`;
}

// Fetch all matches from backend
async function fetchMatches() {
    const res = await fetch("/matches");
    matches = await res.json();
    populateFilters();
    renderTable();
}

function populateFilters() {
    const dateMap = new Map(), teamSet = new Set(), compSet = new Set();
    matches.forEach(m => {
        dateMap.set(m.date, formatDateOption(m.date)); // Crea mapping key: data originale, value: etichetta friendly
        teamSet.add(m.home);
        teamSet.add(m.away);
        compSet.add(m.competition);
    });
    fillSelectCustom("filter-date", dateMap);
    fillSelect("filter-team", Array.from(teamSet));
    fillSelect("filter-comp", Array.from(compSet));
}

function fillSelectCustom(id, map) {
    const sel = document.getElementById(id);
    let opts = `<option value="Tutte">Tutte</option>`;
    for (const [key, txt] of map.entries()) {
        opts += `<option value="${key}">${txt}</option>`;
    }
    sel.innerHTML = opts;
}

function fillSelect(id, arr) {
    const sel = document.getElementById(id);
    sel.innerHTML = `<option value="Tutte">Tutte</option>` + arr.map(v => `<option value="${v}">${v}</option>`).join('');
}

function renderTable() {
    const date = document.getElementById("filter-date").value;
    const team = document.getElementById("filter-team").value;
    const comp = document.getElementById("filter-comp").value;
    const search = document.getElementById("filter-search").value.trim().toLowerCase();

    const filtered = matches.filter(m =>
        (date === "Tutte" || m.date === date) &&
        (team === "Tutte" || m.home === team || m.away === team) &&
        (comp === "Tutte" || m.competition === comp) &&
        (search === "" ||
         m.home.toLowerCase().includes(search) ||
         m.away.toLowerCase().includes(search))
    );

    document.querySelector("#matches-table tbody").innerHTML =
        filtered.map(m =>
        `<tr>
           <td>${formatDateOption(m.date)}</td>
           <td>${m.home}</td>
           <td>${m.away}</td>
           <td>${m.competition}</td>
           <td>${m.channel || ""}</td>
        </tr>`).join('');
}

// Event listeners
document.getElementById("filter-date").addEventListener("change", renderTable);
document.getElementById("filter-team").addEventListener("change", renderTable);
document.getElementById("filter-comp").addEventListener("change", renderTable);
document.getElementById("filter-search").addEventListener("input", renderTable);

fetchMatches();
</script>
</body>
</html>

